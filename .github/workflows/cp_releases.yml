name: Process Releases

permissions:
  contents: write
  
on:
  workflow_dispatch:

jobs:
  process_releases:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout releases branch
        uses: actions/checkout@v3
        with:
          ref: releases

      - name: Download release assets
        run: |
          curl -s https://api.github.com/repos/xyzroe/XZG/releases | jq -r '.[1:] | .[] | .assets[] | select(.name | test("XZG_\\d{8}.full.bin")) | .browser_download_url' | while read url; do
            file_name=$(basename "$url")
            version=${file_name%.full.bin}
            mkdir -p "releases/$version"
            wget -O "releases/$version/$file_name" "$url"
          done

      - name: Create manifests
        run: |
          for dir in releases/*; do
            version=$(basename "$dir")
            file_path="$dir/XZG_${version}.full.bin"
            echo -e "{\n  \"name\": \"XZG Firmware\",\n  \"version\": \"$version\",\n  \"builds\": [\n    {\n      \"chipFamily\": \"ESP32\",\n      \"improv\": false,\n      \"parts\": [\n        {\n          \"path\": \"$file_path\",\n          \"offset\": 0\n        }\n      ]\n    }\n  ]\n}" > "$dir/manifest.json"
          done

      - name: Push changes
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add .
          git commit -m "Update releases with new manifests and FW files"
          git push
